L.tileLayerCordova=function(e,t,o){return new L.TileLayer.Cordova(e,t,o)},L.TileLayer.Cordova=L.TileLayer.extend({initialize:function(e,t,o){if(t=L.extend({folder:null,name:null,autocache:!1,debug:!1},t),!t.folder)throw"L.TileLayer.Cordova: missing required option: folder";if(!t.name)throw"L.TileLayer.Cordova: missing required option: name";L.TileLayer.prototype.initialize.call(this,e,t),L.setOptions(this,t);var n=this;if(n._url_online=n._url,!window.requestFileSystem&&this.options.debug&&console.log("L.TileLayer.Cordova: device does not support requestFileSystem"),!window.requestFileSystem)throw"L.TileLayer.Cordova: device does not support requestFileSystem";return n.options.debug&&console.log("Opening filesystem"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){n.options.debug&&console.log("requestFileSystem OK "+t.folder),n.fshandle=e,n.fshandle.root.getDirectory(t.folder,{create:!0,exclusive:!1},function(e){n.options.debug&&console.log("getDirectory OK "+t.folder),n.dirhandle=e,n.dirhandle.setMetadata(null,null,{"com.apple.MobileBackup":1}),n._url_offline=e.toURL()+"/"+[n.options.name,"{z}","{x}","{y}"].join("-")+".png",o&&o()},function(e){throw n.options.debug&&console.log("getDirectory failed (code "+e.code+")"+t.folder),"L.TileLayer.Cordova: "+t.name+": getDirectory failed with code "+e.code})},function(e){throw n.options.debug&&console.log("requestFileSystem failed (code "+e.code+")"+t.folder),"L.TileLayer.Cordova: "+t.name+": requestFileSystem failed with code "+e.code}),this},goOnline:function(){this.setUrl(this._url_online)},goOffline:function(){this.setUrl(this._url_offline)},isOnline:function(){return this._url==this._url_online},isOffline:function(){return this._url==this._url_offline},calculateXYZListFromPyramid:function(e,t,o,n){var i=[];for(z=o;z<=n;z++){var r=this.getX(t,z),a=this.getY(e,z),l=z==o?0:Math.pow(2,z-o-1);this.options.debug&&console.log("Calculate pyramid: Z "+z+" : Radius of "+l);for(var s=r-l;r+l>=s;s++)for(var u=a-l;a+l>=u;u++)i.push({x:s,y:u,z:z})}return i},calculateXYZListFromBounds:function(e,t,o){var n=[];for(z=t;z<=o;z++){t1_x=this.getX(e.getNorthWest().lng,z),t1_y=this.getY(e.getNorthWest().lat,z),t2_x=this.getX(e.getSouthEast().lng,z),t2_y=this.getY(e.getSouthEast().lat,z);for(var i=t1_x;i<=t2_x;i++)for(var r=t1_y;r<=t2_y;r++)n.push({x:i,y:r,z:z})}return n},getX:function(e,t){return Math.floor((e+180)/360*Math.pow(2,t))},getY:function(e,t){return Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))},getLng:function(e,t){return e/Math.pow(2,t)*360-180},getLat:function(e,t){var o=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)))},downloadAndStoreTile:function(e,t,o,n,i){var r=this,a=r.dirhandle.toURL()+"/"+[r.options.name,o,e,t].join("-")+".png",l=r._url_online.replace("{z}",o).replace("{x}",e).replace("{y}",t);if(r.options.subdomains){var s=Math.floor(Math.random()*r.options.subdomains.length),u=r.options.subdomains[s];l=l.replace("{s}",u)}r.options.debug&&console.log("Download "+l+" => "+a);var d=new FileTransfer;d.download(l,a,function(e){e.setMetadata(null,null,{"com.apple.MobileBackup":1}),n&&n()},function(e){var t;switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:t="One of these was not found:\n",t+=urls[index].url+"\n",t+=urls[index].filename;break;case FileTransferError.INVALID_URL_ERR:t="Invalid URL:\n",t+=urls[index].url+"\n",t+=urls[index].filename;break;case FileTransferError.CONNECTION_ERR:t="Connection error at the web server.\n"}i&&i(t)})},downloadXYZList:function(e,t,o,n,i){function r(e,o,n,i,l){function s(){n&&n(o,e.length),o+1<e.length?r(e,o+1,n,i,l):i&&i()}function u(){a.downloadAndStoreTile(d,c,f,s,function(e){l&&l(e)})}var d=e[o].x,c=e[o].y,f=e[o].z;if(t)a.options.debug&&console.log("Tile "+f+"/"+d+"/"+c+" -- Overwrite=true so proceeding."),u();else{var h=[a.options.name,f,d,c].join("-")+".png";a.dirhandle.getFile(h,{create:!1},function(){a.options.debug&&console.log(h+" exists. Skipping."),s()},function(){a.options.debug&&console.log(h+" missing. Fetching."),u()})}}var a=this;r(e,0,o,n,i)},getDiskUsage:function(e){var t=this,o=t.dirhandle.createReader();o.readEntries(function(t){function o(r){return r>=t.length?void(e&&e(n,i)):void t[r].file(function(e){i+=e.size,n++,o(r+1)},function(){o(r+1)})}var n=0,i=0;o(0)},function(){throw"L.TileLayer.Cordova: getDiskUsage: Failed to read directory"})},emptyCache:function(e){var t=this,o=t.dirhandle.createReader();o.readEntries(function(t){function o(r){return r>=t.length?void(e&&e(n,i)):void t[r].remove(function(){n++,o(r+1)},function(){i++,o(r+1)})}var n=0,i=0;o(0)},function(){throw"L.TileLayer.Cordova: emptyCache: Failed to read directory"})},getCacheContents:function(e){var t=this,o=t.dirhandle.createReader();o.readEntries(function(o){for(var n=[],i=0;i<o.length;i++){var r=o[i];if(r.isFile){var a={name:r.name,fullPath:r.fullPath,nativeURL:r.nativeURL},l=r.name.split(".");if(l.length>=1){var s=l[0].split("-");s.length>=4&&(a.z=s[1],a.x=s[2],a.y=s[3],a.lat=t.getLat(a.y,a.z),a.lng=t.getLng(a.x,a.z))}n.push(a)}}e&&e(n)},function(){throw"L.TileLayer.Cordova: getCacheContents: Failed to read directory"})}});